# MySQL 数据库事务

场景引入：学工部整个部门解散，该部门及部门下的员工都需要删除。

执行 SQL 命令：

```mysql
-- 删除学工部
DELETE
FROM dept
WHERE id = 1; -- 删除成功

-- 删除学工部的员工
DELETE
FROM emp
WHERE dept_id = 1; -- 删除失败（操作过程中出现错误：造成删除没有成功）
```

问题：如果删除部门成功了，而删除该部门的员工时失败了，此时就造成了数据的不一致。

要解决上述的问题，就需要使用数据库中的**事务**。

在实际业务开发中，有些业务操作，要多次访问数据库。一个业务要发送多条 SQL 语句给数据库执行：

- 那么就需要将多次访问数据库的操作视为一个整体来执行；
  - 要么所有的 SQL 语句全部执行成功；
  - 如果其中有一条 SQL 语句失败，就进行**事务的回滚**，所有的 SQL语句全部执行失败。

## 一、事务是什么？

事务，是一组操作的集合，它是一个不可分割的工作单位。

事务，会把所有的操作作为一个整体，一并向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。

事务，用于保证在多次操作数据库表中数据时，要么全都成功，要么全都失败。

## 二、MySQL 事务控制（操作）

MySQL 中，有两种方式，进行事务的操作：

1. 自动提交事务：即执行一条 SQL 语句，提交一次事务（默认的事务提交方式）。
2. 手动提交事务：先手动开启事务，再手动提交事务，或手动回滚事务；

事务控制（操作）有关的 SQL 语句如下：

| SQL语句                        | 描述             |
| ------------------------------ | ---------------- |
| `START TRANSACTION;`  /  `BEGIN;` | 手动**开启事务** |
| `COMMIT;`                      | 手动**提交事务** |
| `ROLLBACK;`                    | 手动**回滚事务**   |

手动控制事务，有两种情况：

- 情况一：开启事务  =>  执行 SQL 语句   =>  成功  =>  提交事务
- 情况二：开启事务  =>  执行 SQL 语句   =>  失败  =>  回滚事务

案例理解：使用事务控制，删除部门，和该部门下的员工：

```mysql
-- 开启事务
START TRANSACTION;

-- 删除学工部
DELETE
FROM dept
WHERE id = 1;

-- 删除学工部的员工
DELETE
FROM emp
WHERE dept_id = 'haha'; -- 故意写错 SQL 语句，用来模拟错误

-- 提交事务 (成功时执行)
COMMIT;

-- 回滚事务 (出错时执行)
ROLLBACK;
```

- 当执行完第二条 SQL 语句后：
  - 在当前窗口下执行 `SELECT * FROM dept`，发现学工部已被删除；
  - 新建窗口，执行`SELECT * FROM dept`，发现学工部未删除；
  - 可知：事务（执行窗口）之间是相互隔离的。

## 三、事务四大特性

事务有四大特性（ACID）

- **原子性（Atomicity）**：事务是不可分割的最小单元，要么全部成功，要么全部失败。
- **一致性（Consistency）**：事务完成时，必须使所有的数据都保持一致状态。
  - 如果事务执行成功，那么数据库的所有变化将生效。
  - 如果事务执行出现错误，那么数据库的所有变化将会被回滚（撤销），返回到原始状态。
- **隔离性（Isolation）**：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。
  - 隔离性越高，事务越安全，效率越低。
  - 实际开发中，一般使用默认的设置。
- **持久性（Durability）**：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。
